---
id: REQ-009
title: Achieve 95% code coverage across service layers
status: completed
claimed_at: 2026-02-05T05:45:00Z
route: C
created_at: 2026-02-04T13:12:00Z
user_request: UR-001
related: [REQ-010, REQ-011]
batch: testing-comprehensive
---

# Achieve 95% code coverage across service layers

## What
Achieve 95% code coverage across all critical service layers with comprehensive unit tests.

## Detailed Requirements
- Must achieve 95% code coverage across all critical service layers
- Implement comprehensive unit tests for business logic components
- Add test coverage for security features (REQ-002, REQ-003, REQ-004)
- Include performance feature test coverage (REQ-005, REQ-006, REQ-007, REQ-008)
- Implement test coverage for error handling and edge cases
- Add mock objects and test doubles for external dependencies
- Include parameterized tests for various input scenarios
- Implement test coverage for exception handling paths
- Add integration between unit tests and performance benchmarks
- Include coverage for configuration and environment-specific code
- Implement continuous integration test execution and reporting
- Add test maintenance procedures for code evolution
- Include coverage for data validation and transformation logic

## Dependencies
- Related: REQ-010 (unit tests complement integration tests), REQ-011 (unit tests feed into smoke testing)
- Must test all previously implemented security and performance features
- Priority: P1 - essential for code quality and reliability

## Builder Guidance
- Certainty level: Firm (explicit 95% coverage requirement)
- Scope cues: "comprehensive", "critical service layers" - no shortcuts on test breadth
- Must integrate with existing test framework without breaking current tests

## Full Context
See [user-requests/UR-001/input.md](./user-requests/UR-001/input.md) for complete verbatim input.

---

*Source: UR-001/input.md - ScottWisper-04y8*



---



## Triage



**Route: C** - Complex



**Reasoning:** Achieving 95% code coverage is a high-effort task that requires deep analysis of existing tests, identifying gaps in critical service layers, and implementing a large volume of high-quality unit tests. It also involves setting up coverage reporting and integrating it into the development workflow.



**Planning:** Required



## Plan



### Implementation Strategy



**Phase 1: Baseline and Analysis**

1. **Generate Current Coverage Report**

   - Use `dotnet test /p:CollectCoverage=true` with Coverlet.

   - Identify critical service layers below the 95% threshold.



2. **Map Critical Service Layers**

   - WhisperService

   - AudioCaptureService

   - ApiKeyManagementService

   - AuditLoggingService

   - JsonDatabaseService

   - InputValidationService

   - RecoveryPolicyService



**Phase 2: Security and Infrastructure Coverage**

3. **Enhance Security Tests**

   - Add exhaustive edge-case tests for `InputValidationService`.

   - Add multi-provider rotation tests for `ApiKeyManagementService`.

   - Add failure-path tests for `AuditLoggingService` (e.g., directory permission issues).



4. **Enhance Performance Tests**

   - Add capacity-limit and concurrent-access tests for `ByteArrayPool`.

   - Add cache-miss and invalidation tests for `JsonDatabaseService`.



**Phase 3: Core Business Logic Coverage**

5. **Enhance WhisperService Tests**

   - Add mock-based tests for all HTTP error status codes.

   - Test rate limiter interactions and state persistence.

   - Test local fallback triggers and execution paths.



6. **Enhance AudioCaptureService Tests**

   - Add mock-based tests for device enumeration and initialization failures.

   - Test buffer overflow and error event scenarios.



**Phase 4: Reporting and Enforcement**

7. **Configure Coverage Enforcement**

   - Set threshold in `coverlet.runsettings` or CI pipeline.

   - Fail build if coverage drops below 95% for service projects.



8. **Automated Reporting**

   - Generate HTML reports for local development.

   - Post coverage summaries to PRs.



### Technical Decisions

- **Tooling**: Use `Coverlet.Collector` for data collection and `ReportGenerator` for visual analysis.

- **Scope**: Focus coverage on `src/Services` and `src/Models`; exclude UI components (Views) where 95% is impractical for standard unit tests.

- **Quality over Quantity**: Prioritize testing edge cases and branching logic over simple getter/setter coverage.



*Generated by Plan agent*


## Exploration

### Test Project Structure
- **Location:** `Tests/WhisperKey.Tests.csproj`
- **Framework:** MSTest v3.1.1 with Moq v4.20.69
- **Target:** .NET 8.0-windows
- **Organization:** Unit/ (30+ files), Integration/ (6 files - excluded), Performance/, E2E/

### Coverage Tooling In Place
- **Coverlet:** coverlet.collector v6.0.0, coverlet.msbuild v6.0.0
- **Config:** `coverlet.runsettings` with 80% threshold (needs 95%)
- **Current includes:** WhisperKey.Services*, WhisperKey.Exceptions*

### Critical Service Locations

| Service | Source | Test File | Lines |
|---------|--------|-----------|-------|
| WhisperService | WhisperService.cs | Tests/Unit/WhisperServiceTests.cs | ~799 |
| AudioCaptureService | AudioCaptureService.cs | Tests/Unit/AudioCaptureServiceTests.cs | ~477 |
| ApiKeyManagementService | src/Services/ApiKeyManagementService.cs | Tests/Unit/ApiKeyManagementTests.cs | ~279 |
| AuditLoggingService | src/Services/AuditLoggingService.cs | Tests/Unit/AuditLoggingTests.cs | ~873 |
| JsonDatabaseService | src/Services/Database/JsonDatabaseService.cs | Integration only | ~184 |
| InputValidationService | src/Services/Validation/InputValidationService.cs | Tests/Unit/InputValidationTests.cs | ~44 |
| RecoveryPolicyService | src/Services/Recovery/RecoveryPolicyService.cs | Tests/Unit/ErrorRecoveryTests.cs | ~109 |

### Coverage Gaps Identified

**Phase 2 - Security/Infrastructure:**
- ApiKeyManagementService: Missing RevokeKeyAsync, ListKeysAsync, RecordUsageAsync, CheckExpirationsAsync, ProcessAutomaticRotationsAsync
- AuditLoggingService: Missing VerifyHashChainAsync, complex retention policies, concurrent logging
- JsonDatabaseService: Missing unit tests (only integration), cache invalidation, concurrent access
- InputValidationService: Needs more complex validation rules

**Phase 3 - Core Business Logic:**
- WhisperService: HTTP error codes 429/502/503/504, local inference fallback (tests ignored), circuit breaker transitions
- AudioCaptureService: Buffer overflow, memory pool edge cases, device enumeration errors
- RecoveryPolicyService: ExecuteWithRecoveryAsync, half-open state testing

**Phase 4 - Performance:**
- ByteArrayPool: GenericObjectPool<T> completely untested, max size enforcement, multi-threaded scenarios

### CI/CD Issues Found
- **Bug:** CI references wrong test path (`test/WhisperKey.Tests/` instead of `Tests/`)
- **Missing:** Coverage collection, threshold enforcement, report upload

### Key Files for New Tests
1. `Tests/Unit/JsonDatabaseServiceTests.cs` (create new)
2. `Tests/Unit/GenericObjectPoolTests.cs` (create new)
3. Enhance: ApiKeyManagementTests.cs, AuditLoggingTests.cs, RecoveryPolicyTests.cs
4. Fix CI: `.github/workflows/ci-cd.yml`
5. Update: `coverlet.runsettings` (80% â†’ 95%)

*Generated by Explore agent*
