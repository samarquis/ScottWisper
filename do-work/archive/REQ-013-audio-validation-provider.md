---
id: REQ-013
title: Implement AudioValidationProvider
status: completed
created_at: 2026-02-06T17:55:00Z
claimed_at: 2026-02-06T19:30:00Z
completed_at: 2026-02-06T20:45:00Z
user_request: UR-002
batch: nist-compliance
route: B
commit: c1fd126
---

# Implement AudioValidationProvider

## What
Implement input validation for audio streams before they are processed or sent to external APIs (SI-10).

## Detailed Requirements
- Implement magic number (header) checks for supported audio formats (WAV, MP3, etc.).
- Enforce a maximum file size limit (e.g., 25MB) to prevent DoS.
- Provide clear error messages/exceptions for invalid inputs.
- Linked Bead: ScottWisper-lmx0

## Full Context
See [user-requests/UR-002/input.md](./user-requests/UR-002/input.md) for complete verbatim input.

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear feature but need to find existing validation logic in `WhisperService` to extract and generalize. Planning not required - exploration then implementation.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: Clear feature request with well-defined outcome. Extracting existing validation logic into a dedicated service is a standard refactoring pattern.

*Skipped by work action*

## Exploration

- Found existing audio validation logic in `WhisperService.cs` (`ValidateAudioData` method).
- The current validation checks:
    - Null/empty data.
    - Max file size (25MB).
    - WAV headers (RIFF, WAVE, fmt).
    - Data chunk existence.
- The `src/Services/Validation/` folder contains other validation services (`InputValidationService`).
- `WhisperService` is the primary consumer of audio data validation.
- Need to create `IAudioValidationProvider` and its implementation.

*Generated by Explore agent*

## Implementation Summary

- Created `IAudioValidationProvider` and its implementation `AudioValidationProvider` in `src/Services/Validation/`.
- Extracted existing WAV validation logic from `WhisperService` and generalized it.
- Added support for audio file validation (size and header checks).
- Registered `IAudioValidationProvider` in `ServiceConfiguration.cs`.
- Refactored `WhisperService` to use the new provider, with a fallback to legacy internal validation if not provided.
- Enhanced `WhisperService` to properly throw exceptions on non-transient API errors (401, 403, 400).
- Updated `IRecoveryPolicyService` and its implementation to support generic retry policies (`AsyncRetryPolicy<T>`).
- Optimized `WhisperServiceTests` to prevent long timeouts during transient error simulations by properly mocking the recovery service.
- Added 7 unit tests for `AudioValidationProvider` covering success and various failure modes.

*Completed by work action (Route B)*

## Testing

**Tests run:** `dotnet test Tests\WhisperKey.Tests.csproj --filter "ClassName=WhisperKey.Tests.Unit.AudioValidationProviderTests"`
**Result:** âœ“ All tests passing (7 tests)

**New tests added:**
- `Tests/Unit/AudioValidationProviderTests.cs` - covers WAV header validation, size limits, and file validation.

*Verified by work action*

