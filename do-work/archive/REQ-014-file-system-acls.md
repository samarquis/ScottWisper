---
id: REQ-014
title: Implement File System ACLs
status: completed
created_at: 2026-02-06T17:55:00Z
claimed_at: 2026-02-06T21:00:00Z
completed_at: 2026-02-06T22:30:00Z
user_request: UR-002
batch: nist-compliance
route: B
commit: a725b3a
---

# Implement File System ACLs

## What
Enforce strict NTFS permissions on configuration and settings files to prevent unauthorized access by other users on shared machines (AC-3).

## Detailed Requirements
- Use `FileSecurity` to set access rules on `appsettings.json` and user settings files.
- Restrict access to the current user SID and System only.
- Ensure inheritance is handled correctly to maintain security.
- Linked Bead: ScottWisper-jsx0

## Full Context
See [user-requests/UR-002/input.md](./user-requests/UR-002/input.md) for complete verbatim input.

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear requirement to apply NTFS ACLs. Need to identify all sensitive files and directories where settings are stored and implement a robust permission enforcement mechanism.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: The task is well-defined: apply NTFS permissions to specific files. Exploration will identify the exact file paths and existing file service patterns.

*Skipped by work action*

## Exploration

- Found that `FileSettingsRepository.cs` already has some logic for enforcing secure permissions on `usersettings.json` using Windows ACLs (`FileSecurity`, `DirectorySecurity`).
- Current logic restricts access to the current user only but doesn't explicitly include the `SYSTEM` account.
- Strict permissions are not yet applied to `appsettings.json` or other potential configuration files in the base directory.
- `FileSystemService` exists as an abstraction for file operations but doesn't yet expose permission management methods.
- Refactoring permission logic into `FileSystemService` will allow centralized and consistent enforcement.

*Generated by Explore agent*

## Implementation Summary

- Enhanced `IFileSystemService` and its implementation `FileSystemService` with a new `SetStrictPermissions(string path)` method.
- The implementation uses `FileSecurity` and `DirectorySecurity` to:
    - Disable ACL inheritance (`SetAccessRuleProtection(true, false)`).
    - Grant `FullControl` to the current user identity.
    - Grant `FullControl` to the `SYSTEM` account identity.
    - Explicitly handles both files and directories with appropriate inheritance flags for directories.
- Refactored `FileSettingsRepository` to utilize the new centralized permission enforcement for `usersettings.json`, its parent folder, and backup files.
- Updated `ApplicationBootstrapper` to automatically apply strict permissions to `appsettings.json` in the application base directory upon initialization.
- Adjusted `ServiceConfiguration` to ensure `IFileSystemService` is registered before `ISettingsRepository` to satisfy the new dependency.
- Fixed numerous unit tests in `SettingsTests.cs` and `SettingsValidationTests.cs` by updating `FileSettingsRepository` instantiation to include the required `IFileSystemService`.
- Added a new unit test suite `FileSystemAclTests.cs` to verify that permissions are correctly applied to both files and directories.

*Completed by work action (Route B)*

## Testing

**Tests run:** `dotnet test Tests\WhisperKey.Tests.csproj --filter "ClassName=WhisperKey.Tests.Unit.FileSystemAclTests"`
**Result:** ✓ All tests passing (2 tests)

**Tests run:** `dotnet test Tests\WhisperKey.Tests.csproj --filter "ClassName=WhisperKey.Tests.Unit.SettingsTests"`
**Result:** ✓ All tests passing (8 tests)

**New tests added:**
- `Tests/Unit/FileSystemAclTests.cs` - verifies ACL rules for current user and SYSTEM.

*Verified by work action*

