---
id: REQ-003
title: API key rotation and management system
status: claimed
claimed_at: 2026-02-04T14:40:00Z
route: C
created_at: 2026-02-04T13:12:00Z
user_request: UR-001
related: [REQ-002, REQ-004]
batch: security-foundation
---

# API key rotation and management system

## What
Add API key rotation and management system with automatic expiration notifications and zero-downtime rotation.

## Detailed Requirements
- Must support automatic API key rotation on configurable schedules
- Must provide zero-downtime rotation (new keys active before old keys expire)
- Must send automatic expiration notifications via multiple channels
- Support manual and automatic key rotation workflows
- Implement key versioning system for rollback capability
- Include rate limiting and usage tracking per API key
- Provide secure key generation using cryptographic best practices
- Support key permissions and scopes (least privilege principle)
- Include audit logging integration with REQ-002
- Implement secure key storage with encryption at rest
- Support emergency key revocation procedures
- Provide API key usage analytics and reporting

## Dependencies
- Depends on: REQ-002 (needs audit logging for rotation events)
- Depends on: REQ-004 (input validation for key management APIs)
- Priority: P1 - critical security infrastructure

## Builder Guidance
- Certainty level: Firm (explicit zero-downtime requirement)
- Scope cues: "comprehensive", "automatic expiration notifications" - no manual processes overlooked
- Must maintain backward compatibility with existing API key systems

## Full Context
See [user-requests/UR-001/input.md](./user-requests/UR-001/input.md) for complete verbatim input.

---

*Source: UR-001/input.md - ScottWisper-co70*



---



## Triage



**Route: C** - Complex



**Reasoning:** Implementing a full API key management system with automatic rotation, zero-downtime, and notifications is a significant architectural undertaking. It requires new services, models, and integration with existing components.



## Plan

### Implementation Strategy

**Phase 1: API Key Models and Storage**
1. **Define API Key Models** (src/Models/ApiKey.cs)
   - Properties: Id, KeyHash, Name, Status (Active, Deprecated, Expired, Revoked), CreatedAt, ExpiresAt, LastUsedAt, Version, Scopes.
   - Support multiple versions of keys for zero-downtime rotation.

2. **Enhance WindowsCredentialService** (src/Services/WindowsCredentialService.cs)
   - Store API key metadata alongside the keys.
   - Implement secure versioning in storage.

**Phase 2: Rotation and Management Core**
3. **Create IApiKeyManagementService** (src/Services/IApiKeyManagementService.cs)
   - Methods: GenerateKey, RotateKeyAsync, RevokeKey, ValidateKey, GetUsageStats.

4. **Implement ApiKeyRotationService** (src/Services/ApiKeyRotationService.cs)
   - Handle automatic rotation schedules.
   - Manage the transition between old and new keys (zero-downtime).
   - Integration with `IAuditLoggingService` for all rotation events.

**Phase 3: Notifications and Integration**
5. **Create NotificationService** (src/Services/NotificationService.cs)
   - Support toast notifications, logs, and potential webhook alerts.
   - Alert user before key expiration (e.g., 7 days, 1 day).

6. **Integrate with Transcription Providers** (src/Services/WhisperService.cs)
   - Update providers to use the new management system for API key retrieval.
   - Ensure graceful handling of rotated keys.

**Phase 4: Testing and Verification**
7. **Unit Tests**
   - Key generation cryptographic strength.
   - Rotation logic verification (zero-downtime).
   - Expiration and revocation handling.

8. **Integration Tests**
   - End-to-end rotation with a mock provider.
   - Notification triggering.

### Technical Decisions
- **Zero-Downtime**: During rotation, both the old and new keys will be valid for a "grace period" (e.g., 24 hours).
- **Security**: Store only hashes of API keys where possible, or use DPAPI for full key storage as already implemented.
- **Audit**: Log all lifecycle events (Created, Rotated, Revoked, AccessDenied).

*Generated by Plan agent*
