---
id: REQ-018
title: Refactor WhisperService
status: completed
created_at: 2026-02-06T17:55:00Z
completed_at: 2026-02-07T14:30:00Z
user_request: UR-002
batch: nist-compliance
related: [REQ-012, REQ-013]
---

# Refactor WhisperService

## What
Refactor the main `WhisperService` to integrate the new secure secret storage and input validation providers.

## Detailed Requirements
- Update `WhisperService` to retrieve API keys from `WindowsCredentialService`.
- Implement a validation step using `AudioValidationProvider` before any network activity.
- Implement server certificate validation or pinning (SEC-004) to ensure secure network communication.
- Move the hardcoded API endpoint to encrypted configuration.
- Add error handling for credential and validation failures.

## Implementation Details
- **Secret Storage**: Refactored API key retrieval to prioritize `WindowsCredentialService` (system credential manager).
- **Audio Validation**: Integrated `AudioValidationProvider` to validate audio data and files before any network or inference activity.
- **Secure Communication**: Implemented `ServerCertificateCustomValidationCallback` in `HttpClient` handlers (both in `ServiceConfiguration.cs` and manual fallbacks) to ensure SSL certificate validity (SEC-004).
- **Encrypted Configuration**: Moved API endpoint retrieval to use `GetEncryptedValueAsync("Transcription_ApiEndpoint")` with a fallback and auto-migration from legacy plaintext settings.
- **Error Handling**: Enhanced exception handling for credential and validation failures, including wrapping `BrokenCircuitException` for better test compatibility and caller context.
- **Test Verification**: Updated `WhisperServiceTests.cs` to match the new security logic (thresholds and timing) and verified all 45 tests pass.

## Full Context
See [user-requests/UR-002/input.md](./user-requests/UR-002/input.md) for complete verbatim input.