---
id: REQ-015
title: Upgrade Settings Encryption
status: completed
created_at: 2026-02-06T17:55:00Z
completed_at: 2026-02-07T12:00:00Z
user_request: UR-002
batch: nist-compliance
---

# Upgrade Settings Encryption

## What
Harden the encryption used for application settings by improving key derivation (SC-28).

## Detailed Requirements
- Replace machine-name/username-based keys with a high-entropy source.
- Use PBKDF2 with a random salt or DPAPI User-Scope encryption.
- Ensure backward compatibility or a migration path for existing settings.
- Linked Bead: ScottWisper-kkna

## Implementation Details
- Integrated `ICredentialService` (Windows Credential Manager) to store a unique `MasterSecret`.
- Implemented `EncryptStringAsync` and `DecryptStringAsync` using DPAPI with derived entropy.
- Used PBKDF2 (Rfc2898DeriveBytes) with 10,000 iterations to derive entropy from `MasterSecret` and a 16-byte random salt.
- Ciphertext format: `Base64(salt + protectedBytes)`.
- Added legacy fallback to support existing settings encrypted with predictable machine/user-based entropy.
- Verified with new unit tests in `SettingsEncryptionUpgradeTests.cs`.

## Full Context
See [user-requests/UR-002/input.md](./user-requests/UR-002/input.md) for complete verbatim input.
