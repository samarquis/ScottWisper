---
phase: 02-windows-integration
plan: 23
type: execute
wave: 1
depends_on: []
files_modified: ["Services/AudioDeviceService.cs", "AudioCaptureService.cs"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Application gracefully handles microphone permission requests and device changes"
    - "User sees user-friendly message when microphone access is denied"
    - "Application provides guidance for enabling microphone permissions"
    - "Windows permission dialogs are properly triggered when needed"
  artifacts:
    - path: "Services/AudioDeviceService.cs"
      provides: "Device enumeration with permission request handling"
      contains: "RequestMicrophonePermission, HandleUnauthorizedException"
    - path: "AudioCaptureService.cs"
      provides: "Audio capture with permission error handling"
      contains: "UnauthorizedAccessException handling, user-friendly error messages"
  key_links:
    - from: "AudioCaptureService.cs"
      to: "Windows Settings"
      via: "Permission request dialogs"
      pattern: "UnauthorizedAccessException.*microphone.*permission"
    - from: "Services/AudioDeviceService.cs"
      to: "Windows Permission System"
      via: "Device access validation"
      pattern: "RequestMicrophonePermission|CheckMicrophoneAccess"
---

<objective>
Implement comprehensive microphone permission handling for Windows to gracefully handle permission requests and provide user-friendly error messages when access is denied.

Purpose: Complete the final missing requirement for Phase 2 Windows Integration - microphone permission handling that ensures users understand how to enable microphone access when it's denied.

Output: Audio capture services with proper Windows permission integration and graceful error handling.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap Context
From VERIFICATION.md - Only remaining gap for Phase 2 completion:
- AudioDeviceService exists with comprehensive device management (1080 lines) but lacks permission handling
- AudioCaptureService provides audio capture but no UnauthorizedAccessException handling
- Missing: Windows microphone permission request handling, user-friendly error messages, graceful fallback

# Existing Implementation
@Services/AudioDeviceService.cs
@AudioCaptureService.cs

Existing services provide comprehensive device enumeration and audio capture but lack Windows permission integration.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Windows microphone permission checking to AudioDeviceService</name>
  <files>Services/AudioDeviceService.cs</files>
  <action>
    Add Windows microphone permission handling to AudioDeviceService.cs:
    
    1. Add permission checking methods:
       - Add CheckMicrophonePermission() method using Windows API to check microphone access status
       - Add RequestMicrophonePermission() method to trigger Windows permission dialog
       - Add GetPermissionStatus() returning enum (Granted, Denied, NotDetermined)
    
    2. Modify existing device enumeration:
       - Check permissions before returning device lists in GetInputDevicesAsync()
       - If permission denied, return empty list with permission denied status
       - Add permission status to AudioDevice model
    
    3. Add permission event handling:
       - Add PermissionDenied event with user-friendly message
       - Add PermissionGranted event when access is successfully obtained
       - Add PermissionRequestFailed event for when user denies permission
    
    4. Implement Windows API integration:
       - Use P/Invoke to call Windows audio permission APIs
       - Handle Windows 10/11 permission model differences
       - Add fallback for older Windows versions
    
    Gap reason: "No permission request handling or graceful fallback when access denied"
  </action>
  <verify>Build project successfully and verify AudioDeviceService has permission checking methods</verify>
  <done>AudioDeviceService can check and request Windows microphone permissions with proper event handling</done>
</task>

<task type="auto">
  <name>Task 2: Add permission exception handling to AudioCaptureService</name>
  <files>AudioCaptureService.cs</files>
  <action>
    Add comprehensive UnauthorizedAccessException handling to AudioCaptureService.cs:
    
    1. Wrap audio initialization in try-catch:
       - Catch UnauthorizedAccessException when accessing microphone
       - Catch SecurityException for permission-related security issues
       - Catch DeviceNotFoundException when device is available but access denied
    
    2. Implement graceful error handling:
       - Add ShowPermissionErrorMessage() method with user-friendly guidance
       - Add OpenWindowsSettings() method to directly open Windows privacy settings
       - Add RetryWithPermission() method to reattempt capture after permission granted
    
    3. Enhance error reporting:
       - Add PermissionRequired event with helpful error messages
       - Add PermissionRetry event for retry scenarios
       - Include step-by-step instructions for enabling microphone access
    
    4. Integration with AudioDeviceService:
       - Subscribe to permission events from AudioDeviceService
       - Check permissions before starting capture in StartCaptureAsync()
       - Handle permission changes during active capture
    
    Gap reason: "No UnauthorizedAccessException handling or permission request logic"
  </action>
  <verify>Test audio capture with microphone denied and verify user-friendly error message appears</verify>
  <done>AudioCaptureService handles permission denials gracefully with user guidance and retry options</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete microphone permission handling system with Windows integration</what-built>
  <how-to-verify>
    1. Build and run the application
    2. Deny microphone access in Windows Settings Privacy -> Microphone
    3. Try to start dictation using the hotkey
    4. Verify that a user-friendly error message appears explaining the permission issue
    5. Verify that the message includes instructions on how to enable microphone access
    6. Enable microphone access and verify dictation works normally
    7. Test device changes while application is running to verify graceful handling
  </how-to-verify>
  <resume-signal>Type "approved" if permission handling works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After implementation, verify that:
- AudioDeviceService can check Windows microphone permission status
- AudioDeviceService can trigger Windows permission dialogs when needed
- AudioCaptureService catches UnauthorizedAccessException and shows user-friendly messages
- Users receive clear guidance when microphone access is denied
- Application gracefully handles permission changes during operation
- All scenarios tested: initial permission request, denied access, granted access, device changes
</verification>

<success_criteria>
The single remaining gap is closed when:
- Application detects microphone permission status before audio capture
- Users see helpful error messages when permission is denied
- Windows permission dialogs are properly triggered
- Application provides guidance to enable microphone access
- Permission changes are handled gracefully during operation
- Phase 2 achieves 6/6 truths verified (completion)
</success_criteria>

<output>
After completion, create `.planning/phases/02-windows-integration/02-23-SUMMARY.md` documenting the microphone permission handling implementation and gap closure.
</output>