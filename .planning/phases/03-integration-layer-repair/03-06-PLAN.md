---
phase: 03-integration-layer-repair
plan: 06
type: execute
wave: 3
depends_on: [03-04, 03-05]
files_modified: [Services/AudioDeviceService.cs, TextInjectionService.cs, SettingsWindow.xaml.cs, App.xaml.cs]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Real-time device change detection with WM_DEVICECHANGE implemented"
    - "Application-specific validation methods for all target applications"
    - "Hotkey conflict detection and resolution functional"
    - "Audio device testing interface with real-time validation"
    - "User-friendly permission request dialogs and guidance"
  artifacts:
    - path: "Services/AudioDeviceService.cs"
      provides: "Complete permission handling with device change monitoring"
      min_lines: 400
    - path: "TextInjectionService.cs"
      provides: "Enhanced cross-application validation with app-specific methods"
      min_lines: 650
    - path: "SettingsWindow.xaml.cs"
      provides: "Complete settings UI with advanced features"
      min_lines: 400
    - path: "App.xaml.cs"
      provides: "Enhanced service integration with gap closure fixes"
      min_lines: 900
  key_links:
    - from: "Services/AudioDeviceService.cs"
      to: "Windows permission system"
      via: "WM_DEVICECHANGE and permission workflows"
      pattern: "MonitorDeviceChanges|ShowPermissionRequestDialog|GuideUserToSettings"
    - from: "TextInjectionService.cs"
      to: "Cross-application validation"
      via: "Application-specific testing methods"
      pattern: "ValidateBrowserInjection|ValidateIDEInjection|ValidateOfficeInjection"
    - from: "SettingsWindow.xaml.cs"
      to: "Settings service"
      via: "Hotkey conflict detection and device testing"
      pattern: "HotkeyConflictDetector|TestDeviceButton|AudioQualityMeter"
---

<objective>
Complete the missing advanced features and user-friendly workflows that were identified as gaps in the verification report, focusing on device change monitoring, application-specific validation, and settings UI advanced features.

Purpose: Implement the missing functionality that prevents Phase 02 gaps from being fully closed, providing users with seamless device management, comprehensive application validation, and complete settings functionality.
Output: Enhanced services with all missing features implemented, providing complete user experience across all scenarios.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-layer-repair/03-integration-layer-repair-VERIFICATION.md

# Missing Features from Verification Report
- Real-time device change detection with WM_DEVICECHANGE missing
- Application-specific validation methods incomplete
- Hotkey conflict detection and resolution missing
- Audio device testing interface missing
- User-friendly permission request dialogs and guidance missing
- API settings validation and testing missing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete AudioDeviceService with device change monitoring and user workflows</name>
  <files>Services/AudioDeviceService.cs</files>
  <action>
    Add the missing device change monitoring and user-friendly permission workflows:
    
    1. Real-time Device Change Detection:
       - Implement MonitorDeviceChanges() method using Windows WM_DEVICECHANGE
       - Add DeviceChangeEventHandler with proper Windows message handling
       - Create DeviceDisconnectedEventHandler and DeviceReconnectedEventHandler
       - Implement automatic device testing when changes detected
       - Add device status notifications to user interface
    
    2. User-Friendly Permission Workflows:
       - Implement ShowPermissionRequestDialog() with clear instructions
       - Add GuideUserToSettings() method for manual permission setup
       - Create PermissionStatusNotifier for system tray updates
       - Implement RetryPermissionRequest with exponential backoff
       - Add PermissionDiagnosticReport generation
    
    3. Graceful Fallback Mechanisms:
       - Implement GracefulFallbackMode when permissions are revoked
       - Add FallbackDeviceSelection when primary device unavailable
       - Create DeviceChangeRecovery logic for transient failures
       - Implement PermissionDeniedEventHandler with user guidance
       - Add comprehensive exception handling for permission scenarios
    
    4. Device Testing and Validation:
       - Add TestDeviceButton functionality with audio level visualization
       - Implement AudioQualityMeter for real-time device testing
       - Create DeviceCompatibilityIndicator for each device
       - Add DefaultDeviceToggle for system integration
       - Implement DeviceChangeNotifier for real-time updates
    
    Gap reason: "Real-time device change detection with WM_DEVICECHANGE", "User-friendly permission request dialogs", "Graceful fallback workflows for permission denial"
  </action>
  <verify>
    1. Build solution with enhanced AudioDeviceService
    2. Verify device change detection monitors WM_DEVICECHANGE correctly
    3. Check permission request dialogs display properly
    4. Validate graceful fallback mechanisms work correctly
  </verify>
  <done>AudioDeviceService enhanced with 150+ additional lines for complete device change monitoring, user-friendly permission workflows, and graceful fallback mechanisms</done>
</task>

<task type="auto">
  <name>Task 2: Complete TextInjectionService with application-specific validation methods</name>
  <files>TextInjectionService.cs</files>
  <action>
    Add the missing application-specific validation methods for all target applications:
    
    1. Browser Validation Methods:
       - Implement ValidateBrowserInjection() for Chrome, Firefox, Edge
       - Add BrowserSpecificWorkarounds for each browser's text field handling
       - Create BrowserTextFieldDetection for various input types
       - Implement BrowserInjectionValidator with accuracy metrics
       - Add AutomatedBrowserNavigation testing support
    
    2. IDE and Editor Validation:
       - Implement ValidateIDEInjection() for Visual Studio
       - Add CodeEditorDetection for different file types
       - Create SyntaxAwareInjection for code contexts
       - Implement EditorPositionValidator for cursor accuracy
       - Add ProjectStructureNavigation for complex scenarios
    
    3. Office Application Validation:
       - Implement ValidateOfficeInjection() for Word, Outlook, Excel
       - Add DocumentTypeDetection for various Office formats
       - Create FormattingPreservationValidator for rich text
       - Implement OfficeApplicationAutomation for UI testing
       - Add TemplateCompatibilityTesting for standard forms
    
    4. Terminal and Command Line Validation:
       - Implement ValidateTerminalInjection() for Windows Terminal, CMD, PowerShell
       - Add ShellDetection for different command environments
       - Create CommandLineContextValidator for prompt accuracy
       - Implement TerminalAutomation for command history testing
       - Add PathCompletionTesting for complex scenarios
    
    5. Notepad++ and Other Applications:
       - Implement ValidateNotepadPlusInjection() for Notepad++
       - Add GenericApplicationValidation for other text editors
       - Create ApplicationCompatibilityMap with all supported apps
       - Implement TargetApplication enum for systematic testing
       - Add retry logic with different injection strategies per application
    
    Gap reason: "Application-specific validation methods for browsers, IDEs, Office, terminal", "Systematic cross-application testing automation"
  </action>
  <verify>
    1. Build solution with enhanced TextInjectionService
    2. Verify all application-specific validation methods exist
    3. Check browser, IDE, Office, and terminal validation implementations
    4. Validate compatibility mapping and target application detection
  </verify>
  <done>TextInjectionService enhanced with 200+ additional lines for complete application-specific validation across all target applications</done>
</task>

<task type="auto">
  <name>Task 3: Complete SettingsWindow with advanced features (conflict detection, device testing)</name>
  <files>SettingsWindow.xaml.cs</files>
  <action>
    Add the missing advanced settings features for complete configuration functionality:
    
    1. Hotkey Conflict Detection and Resolution:
       - Implement HotkeyConflictDetector with real-time validation
       - Add HotkeyConflict class definition and properties
       - Create HotkeyConflictResolver with suggested alternatives
       - Implement HotkeyTestButton to verify hotkey functionality
       - Add HotkeyProfileManager for multiple profiles support
    
    2. Audio Device Testing Interface:
       - Add TestDeviceButton with audio level visualization
       - Implement AudioQualityMeter for real-time device testing
       - Create DeviceCompatibilityIndicator for each device
       - Add DefaultDeviceToggle for system integration
       - Implement DeviceChangeNotifier for real-time updates
    
    3. API Settings Configuration and Validation:
       - Implement APIEndpointTextBox with validation
       - Add APIKeyTextBox with secure password display
       - Create ConnectionTestButton with status feedback
       - Add UsageLimitDisplay with real-time tracking
       - Implement ModelSelectionComboBox for Whisper variants
       - Add RequestTimeoutSlider with value display
    
    4. Settings Validation and Error Handling:
       - Add comprehensive input validation for all settings
       - Implement SettingsErrorProvider with user-friendly messages
       - Create SettingsBackupManager with auto-restore
       - Add SettingsResetButton with confirmation dialog
       - Implement SettingsChangeNotifier for real-time updates
    
    Gap reason: "Hotkey conflict detection and resolution", "Audio device testing interface", "API settings validation and testing", "Resolution of SettingsWindow compilation errors"
  </action>
  <verify>
    1. Build solution with enhanced SettingsWindow
    2. Verify hotkey conflict detection works correctly
    3. Check audio device testing interface functionality
    4. Validate API settings configuration and testing
  </verify>
  <done>SettingsWindow enhanced with 300+ additional lines for complete advanced settings functionality, including conflict detection, device testing, and API configuration</done>
</task>

</tasks>

<verification>
- AudioDeviceService with complete device change monitoring and user workflows
- TextInjectionService with application-specific validation for all target apps
- SettingsWindow with advanced features (conflict detection, device testing, API settings)
- All missing functionality from verification report implemented
- Advanced features compile and integrate correctly with existing services
</verification>

<success_criteria>
Complete advanced functionality implemented across all services, providing users with seamless device management, comprehensive application validation, and full-featured settings interface.
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-layer-repair/03-06-SUMMARY.md`
</output>