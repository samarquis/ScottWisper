---
phase: 03-integration-layer-repair
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [Services/AudioDeviceService.cs, TextInjectionService.cs, SettingsWindow.xaml.cs, IntegrationTests.cs]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Application builds without compilation errors"
    - "Core services can be instantiated and initialized"
    - "Basic text injection functionality operational"
    - "Permission handling methods compile without blocking errors"
  artifacts:
    - path: "Services/AudioDeviceService.cs"
      provides: "Permission request handling without compilation errors"
      min_lines: 400
    - path: "TextInjectionService.cs"
      provides: "Text injection methods without compilation errors"
      min_lines: 650
    - path: "SettingsWindow.xaml.cs"
      provides: "Settings UI without compilation errors"
      min_lines: 400
    - path: "IntegrationTests.cs"
      provides: "Test framework without compilation errors"
      min_lines: 200
  key_links:
    - from: "Services/AudioDeviceService.cs"
      to: "Windows permission system"
      via: "Await/lock pattern fixed"
      pattern: "RequestMicrophonePermissionAsync"
    - from: "TextInjectionService.cs"
      to: "Cross-application injection"
      via: "Null-conditional operators fixed"
      pattern: "InjectTextAtCursor"
    - from: "SettingsWindow.xaml.cs"
      to: "Settings UI components"
      via: "Missing properties added"
      pattern: "HotkeyConflictDetector"
---

<objective>
Resolve the 40+ critical compilation errors that prevent the application from building and running, enabling functional testing of Phase 03 features.

Purpose: Fix blocking anti-patterns in core services to enable application build, testing, and verification of gap closure fixes.
Output: Working application with all compilation errors resolved, allowing functional verification of enhanced services.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-layer-repair/03-integration-layer-repair-VERIFICATION.md

# Critical Blockers from Verification Report
- 40+ major compilation errors prevent application build
- Anti-patterns: await in lock, invalid null-conditional operators, missing properties
- New errors introduced in AudioDeviceService, TextInjectionService, SettingsWindow
- Compilation errors increased from Phase 02, indicating regression
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AudioDeviceService compilation errors (await in lock pattern)</name>
  <files>Services/AudioDeviceService.cs</files>
  <action>
    Fix the critical await-in-lock compilation error in AudioDeviceService:
    
    1. Identify await-in-lock patterns causing compilation errors:
       - Search for `lock` blocks containing `await` calls
       - Review RequestMicrophonePermissionAsync implementation
       - Check device change monitoring async methods
    
    2. Replace with proper async-safe patterns:
       - Use SemaphoreSlim instead of lock for async synchronization
       - Implement proper async/await patterns without lock statements
       - Add ConfigureAwait(false) where appropriate to prevent deadlocks
    
    3. Fix permission handling methods:
       - Ensure RequestMicrophonePermissionAsync compiles correctly
       - Fix CheckMicrophonePermissionStatus implementation
       - Correct PermissionDeniedEventHandler async patterns
    
    4. Resolve device change monitoring:
       - Fix MonitorDeviceChanges async implementation
       - Correct DeviceChangeEventHandler async signatures
       - Implement proper async event handling without locks
    
    Gap reason: "await in lock statement - Blocker - Compilation errors preventing service functionality"
  </action>
  <verify>
    1. Build solution and verify AudioDeviceService compiles without errors
    2. Check that all async methods use proper patterns without lock statements
    3. Verify permission handling methods compile successfully
    4. Validate device change monitoring implementation compiles
  </verify>
  <done>AudioDeviceService compilation errors resolved, service builds successfully with proper async patterns, enabling permission handling functionality</done>
</task>

<task type="auto">
  <name>Task 2: Fix TextInjectionService null-conditional operator errors</name>
  <files>TextInjectionService.cs</files>
  <action>
    Fix invalid null-conditional operators causing compilation errors:
    
    1. Identify invalid null-conditional patterns:
       - Search for `?.` operators applied to non-nullable types
       - Review injection validation methods
       - Check cursor position handling code
    
    2. Replace with proper null handling:
       - Use explicit null checks where null-conditional not valid
       - Fix boolean expression null-conditional usage
       - Correct nullable reference type annotations
    
    3. Fix application-specific validation methods:
       - Ensure ValidateBrowserInjection compiles correctly
       - Fix ValidateIDEInjection implementation patterns
       - Correct ValidateOfficeInjection null handling
    
    4. Resolve injection workflow methods:
       - Fix DetectActiveApplication implementation
       - Correct ApplicationCompatibilityMap usage
       - Ensure cursor position validation methods compile
    
    Gap reason: "Invalid null-conditional operators on bool - Blocker - Compilation errors preventing text injection"
  </action>
  <verify>
    1. Build solution and verify TextInjectionService compiles without errors
    2. Check all null-conditional operators are used correctly
    3. Verify application validation methods compile successfully
    4. Validate injection workflow methods work properly
  </verify>
  <done>TextInjectionService compilation errors resolved, null-conditional operators fixed, enabling text injection functionality across applications</done>
</task>

<task type="auto">
  <name>Task 3: Fix SettingsWindow missing properties and compilation errors</name>
  <files>SettingsWindow.xaml.cs</files>
  <action>
    Resolve missing properties and compilation errors in SettingsWindow:
    
    1. Identify missing class properties and types:
       - Fix HotkeyConflictDetector missing properties
       - Add missing HotkeyConflict class definition or properties
       - Resolve TestDeviceButton and AudioQualityMeter references
       - Fix missing HotkeyRecordingTextBox properties
    
    2. Complete UI component implementations:
       - Add missing backing fields for UI controls
       - Implement missing event handlers and methods
       - Fix property access patterns in settings binding
       - Resolve missing method implementations
    
    3. Fix settings service integration:
       - Ensure SettingsService references compile correctly
       - Fix settings binding and validation code
       - Correct property change notification patterns
       - Resolve missing configuration properties
    
    4. Resolve XAML code-behind issues:
       - Fix event handler signatures and bindings
       - Correct property access from XAML elements
       - Implement missing click handlers and event logic
       - Ensure UI initialization patterns work
    
    Gap reason: "Missing properties in HotkeyConflict class - Blocker - Compilation errors preventing settings UI"
  </action>
  <verify>
    1. Build solution and verify SettingsWindow compiles without errors
    2. Check all UI control properties and references are resolved
    3. Verify settings binding and validation compiles correctly
    4. Validate XAML code-behind integration works properly
  </verify>
  <done>SettingsWindow compilation errors resolved, missing properties and UI components implemented, enabling settings functionality</done>
</task>

</tasks>

<verification>
- Build solution with zero compilation errors
- All core services compile and can be instantiated
- Basic application startup successful
- No blocking anti-patterns remain in core code
- Application can be run for functional testing
</verification>

<success_criteria>
ScottWisper application builds successfully without compilation errors, enabling functional testing of enhanced services and gap closure fixes from previous plans.
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-layer-repair/03-04-SUMMARY.md`
</output>