---
phase: 03-integration-layer-repair
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [TextInjectionService.cs, Services/AudioDeviceService.cs, App.xaml.cs]
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Cross-application text injection validated across target applications (browsers, Visual Studio, Office, Notepad++, terminal)"
    - "Microphone permission handling implemented with graceful fallbacks"
    - "Real-time device change detection and user notifications"
  artifacts:
    - path: "TextInjectionService.cs"
      provides: "Enhanced cross-application compatibility with validation framework"
      min_lines: 650
    - path: "Services/AudioDeviceService.cs"
      provides: "Permission request handling and device change monitoring"
      min_lines: 400
    - path: "IntegrationTests.cs"
      provides: "Automated cross-application compatibility testing"
      min_lines: 200
  key_links:
    - from: "TextInjectionService.cs"
      to: "Cross-application validation"
      via: "Application-specific injection testing"
      pattern: "TestInjectionIn.*Browser|IDE|Office"
    - from: "Services/AudioDeviceService.cs"
      to: "Windows permission system"
      via: "Permission request API"
      pattern: "RequestPermissionAsync|HandlePermissionDenied"
---

<objective>
Enhance TextInjectionService and AudioDeviceService to close critical gaps in cross-application validation and microphone permission handling identified in Phase 02 verification.

Purpose: Ensure universal text injection compatibility across target applications and implement proper Windows microphone permission handling with graceful fallbacks.
Output: Enhanced services with validation framework, permission handling, and human verification checkpoints for cross-application testing.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-windows-integration/02-windows-integration-VERIFICATION.md
@.planning/phases/02-windows-integration/02-01-SUMMARY.md

# Gap Source: Phase 02 Verification Gaps
Gap 1: Cross-Application Text Injection Validation - TextInjectionService.cs exists but not validated across target apps
Gap 2: Microphone Permission Handling - AudioDeviceService.cs missing permission request handling and graceful fallbacks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance TextInjectionService with cross-application validation framework</name>
  <files>TextInjectionService.cs, IntegrationTests.cs</files>
  <action>
    Reference existing TextInjectionService.cs (602 lines) and add:
    
    1. Application-specific compatibility testing methods:
       - ValidateBrowserInjection() for Chrome, Firefox, Edge
       - ValidateIDEInjection() for Visual Studio
       - ValidateOfficeInjection() for Word, Outlook
       - ValidateTerminalInjection() for Windows Terminal, Command Prompt
       - ValidateNotepadPlusInjection() for Notepad++
    
    2. Cross-application compatibility checking:
       - Add TargetApplication enum for supported applications
       - Implement DetectActiveApplication() using Windows API
       - Create ApplicationCompatibilityMap with app-specific injection methods
       - Add retry logic with different injection strategies per application
    
    3. Cursor position accuracy validation:
       - Enhance GetCursorPosition() for different text contexts
       - Add text field detection and cursor position verification
       - Implement position correction for complex UI applications
    
    4. Validation logging and reporting:
       - Add detailed logging for each application test
       - Create CrossApplicationValidationReport
       - Implement performance metrics for injection timing
    
    Gap reason: "Cross-application compatibility testing for browsers, Visual Studio, Office, Notepad++, terminal"
  </action>
  <verify>
    1. Build solution with enhanced TextInjectionService
    2. Run IntegrationTests.cs and verify all application validation methods exist
    3. Check that TargetApplication enum and compatibility mapping are implemented
    4. Validate cursor position accuracy enhancements compile successfully
  </verify>
  <done>TextInjectionService enhanced with 60+ additional lines for cross-application validation framework, supporting all target applications with compatibility testing</done>
</task>

<task type="auto">
  <name>Task 2: Implement microphone permission handling in AudioDeviceService</name>
  <files>Services/AudioDeviceService.cs</files>
  <action>
    Reference existing AudioDeviceService.cs and add:
    
    1. Windows permission request handling:
       - Add RequestMicrophonePermissionAsync() method
       - Implement CheckMicrophonePermissionStatus()
       - Create PermissionDeniedEventHandler for user notifications
       - Add GracefulFallbackMode when permissions are revoked
    
    2. Real-time device change detection:
       - Implement DeviceChangeEventHandler using Windows WM_DEVICECHANGE
       - Add MonitorDeviceChanges() method for continuous monitoring
       - Create DeviceDisconnectedEventHandler and DeviceReconnectedEventHandler
       - Add automatic device testing when changes detected
    
    3. User-friendly permission workflows:
       - ShowPermissionRequestDialog() with clear instructions
       - Implement GuideUserToSettings() for manual permission setup
       - Add PermissionStatusNotifier for system tray updates
       - Create RetryPermissionRequest with exponential backoff
    
    4. Error handling and recovery:
       - Add comprehensive exception handling for permission scenarios
       - Implement DeviceChangeRecovery logic
       - Create PermissionDiagnosticReport
       - Add FallbackDeviceSelection when primary device unavailable
    
    Gap reason: "Microphone permission request handling", "Real-time device change detection", "Graceful fallback when microphone access denied"
  </action>
  <verify>
    1. Build solution with enhanced AudioDeviceService
    2. Verify all permission handling methods compile successfully
    3. Check device change detection event handlers are implemented
    4. Validate fallback mode and user guidance methods exist
  </verify>
  <done>AudioDeviceService enhanced with 150+ additional lines for comprehensive permission handling, device change monitoring, and graceful fallback mechanisms</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced TextInjectionService with cross-application validation framework and AudioDeviceService with permission handling</what-built>
  <how-to-verify>
    1. Cross-Application Text Injection Testing:
       - Open Chrome browser, navigate to any text field (Google search, Gmail compose)
       - Activate ScottWisper hotkey and dictate test text
       - Verify text appears at cursor position in Chrome
       - Repeat for Firefox and Edge
       
    2. IDE Integration Testing:
       - Open Visual Studio, create new code file or open existing
       - Place cursor in code editor
       - Dictate code snippet or comments
       - Verify text appears at exact cursor position with proper indentation
       
    3. Office Application Testing:
       - Open Microsoft Word, place cursor in document
       - Dictate paragraph text
       - Verify text appears with proper formatting and cursor position
       - Test Outlook email compose similarly
       
    4. Permission Handling Testing:
       - Run ScottWisper with microphone access denied in Windows Settings
       - Verify application shows clear permission request dialog
       - Test permission denied scenario and graceful fallback
       - Verify device change detection when connecting/disconnecting microphone
    
    Expected results from verification:
    - Text injection works in all target applications at correct cursor position
    - Permission requests are handled gracefully with clear user guidance
    - Device changes are detected and handled automatically
    - No crashes or error dialogs during testing
  </how-to-verify>
  <resume-signal>Type "approved" if cross-application text injection and permission handling work correctly, or describe specific issues encountered</resume-signal>
</task>

</tasks>

<verification>
- Build succeeds with enhanced services
- Integration tests compile and run
- Cross-application validation framework implemented for all target applications
- Permission handling with graceful fallbacks operational
- Real-time device change detection working
- Human verification confirms universal compatibility
</verification>

<success_criteria>
Cross-application text injection validated across browsers, Visual Studio, Office, Notepad++, and terminal with proper cursor positioning. Microphone permission requests handled gracefully with device change detection and user-friendly error recovery.
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-layer-repair/03-01-SUMMARY.md`
</output>