---
phase: 05-end-to-end-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Tests/EndToEndTests.cs, Tests/DictationFlowValidator.cs]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Complete dictation flow works from hotkey activation to text injection"
    - "Error handling and recovery mechanisms function correctly"
    - "User feedback (audio/visual) appears at all workflow stages"
  artifacts:
    - path: "Tests/EndToEndTests.cs"
      provides: "Comprehensive end-to-end dictation flow tests"
      min_lines: 300
    - path: "Tests/DictationFlowValidator.cs"
      provides: "Automated validation framework for dictation workflows"
      min_lines: 200
  key_links:
    - from: "Tests/DictationFlowValidator.cs"
      to: "HotkeyService, AudioCaptureService, WhisperService, TextInjectionService"
      via: "service orchestration testing"
      pattern: "ValidateDictationPipeline|TestServiceCoordination"
---

<objective>
Validate the complete dictation activation flow from hotkey press through transcription to text injection, ensuring all services coordinate correctly and error handling works as expected.

Purpose: Verify that the core dictation workflow functions reliably in real-world scenarios with proper error recovery.
Output: Comprehensive test suite validating end-to-end dictation flow with detailed reporting.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-end-to-end-validation/05-RESEARCH.md

# Gap Source: Phase 5 End-to-End Validation
Gap 1: Dictation activation flow not validated end-to-end
Gap 2: Service coordination and error handling not tested systematically
Gap 3: User feedback mechanisms not verified in complete workflow
</context>

<tasks>

<task type="auto">
  <name>Create DictationFlowValidator</name>
  <files>Tests/DictationFlowValidator.cs</files>
  <action>
Create DictationFlowValidator class with:
- Constructor accepting all core services (IHotkeyService, IAudioCaptureService, IWhisperService, ITextInjectionService, IFeedbackService)
- ValidateCompleteDictationFlow() method that tests entire pipeline
- Test scenarios:
  * Cold start dictation (first use after launch)
  * Rapid successive dictations (5 in a row)
  * Dictation during high CPU load simulation
  * Dictation with simulated network interruption
  * Dictation with application focus changes
- Service coordination validation:
  * Verify hotkey triggers audio capture
  * Verify audio capture triggers transcription
  * Verify transcription triggers text injection
  * Verify feedback service updates at each stage
- Error handling validation:
  * Test microphone unavailable scenario
  * Test API connection failure scenario
  * Test text injection failure scenario
  * Verify graceful degradation and user notifications
- Return DictationFlowValidationResult with pass/fail per scenario, timing metrics, and error details
  </action>
  <verify>
dotnet build --no-restore succeeds
DictationFlowValidator compiles with all test scenarios
  </verify>
  <done>DictationFlowValidator created with comprehensive workflow testing</done>
</task>

<task type="auto">
  <name>Create EndToEndTests Suite</name>
  <files>Tests/EndToEndTests.cs</files>
  <action>
Create comprehensive EndToEndTests class with xUnit:
- Test_ColdStartDictation: Verify first dictation after application launch
- Test_RapidSuccessiveDictations: 5 dictations in quick succession
- Test_DictationUnderLoad: Dictation while simulating high CPU usage
- Test_NetworkInterruption: Dictation with simulated API failure and recovery
- Test_ApplicationFocusChange: Dictation while switching between applications
- Test_MicrophoneUnavailable: Error handling when microphone is disconnected
- Test_ServiceCoordination: Verify all services work together correctly
- Test_FeedbackMechanisms: Verify audio/visual feedback at each stage
- Test_ErrorRecovery: Verify system recovers from various error conditions
- Test_LatencyRequirements: Verify end-to-end latency < 2 seconds
- Use DictationFlowValidator for systematic validation
- Include detailed assertion messages for debugging
- Add performance metrics collection
  </action>
  <verify>
dotnet build --no-restore succeeds
All test methods compile successfully
Tests can be discovered by test runner
  </verify>
  <done>EndToEndTests suite created with 10+ comprehensive test cases</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dictation flow validation framework with automated tests</what-built>
  <how-to-verify>
1. Run the application and perform a cold start dictation:
   - Launch ScottWisper
   - Press the configured hotkey
   - Speak a test phrase
   - Verify text appears in active application
   - Confirm audio/visual feedback appears at each stage

2. Test rapid successive dictations:
   - Perform 5 dictations in quick succession (< 10 seconds apart)
   - Verify all transcriptions complete successfully
   - Check for memory leaks or performance degradation

3. Test error scenarios:
   - Disconnect microphone and attempt dictation
   - Verify clear error message appears
   - Reconnect microphone and verify recovery
   - Disable network and attempt dictation
   - Verify appropriate fallback or error handling

4. Run automated test suite:
   - Execute: dotnet test --filter "FullyQualifiedName~EndToEndTests"
   - Verify all tests pass
   - Review test output for timing metrics

Expected results:
- All dictation scenarios work correctly
- Error handling is graceful with clear user feedback
- Automated tests pass with < 2 second average latency
- No crashes or unhandled exceptions
  </how-to-verify>
  <resume-signal>Type "approved" if dictation flow validation passes, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
- Build succeeds with new test files
- DictationFlowValidator validates complete pipeline
- EndToEndTests cover all critical scenarios
- Automated tests pass successfully
- Manual verification confirms real-world functionality
</verification>

<success_criteria>
Complete dictation activation flow validated from hotkey to text injection with proper service coordination, error handling, and user feedback mechanisms working correctly across all test scenarios.
</success_criteria>

<output>
After completion, create `.planning/phases/05-end-to-end-validation/05-01-SUMMARY.md`
</output>
