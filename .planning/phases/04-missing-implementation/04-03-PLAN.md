---
phase: 04-missing-implementation
plan: 03
type: execute
wave: 2
depends_on: [04-02]
files_modified: [src/Services/AudioDeviceService.cs, src/Services/PermissionService.cs, src/UI/PermissionDialog.xaml, src/UI/PermissionDialog.xaml.cs]
autonomous: true
must_haves:
  truths:
    - "Microphone permissions are properly requested and handled"
    - "Audio device switching works reliably across different microphones"
    - "User receives clear guidance for permission issues"
  artifacts:
    - path: "src/Services/AudioDeviceService.cs"
      provides: "Enhanced audio device management with permission handling"
      contains: "RequestMicrophonePermissionAsync, SwitchDeviceAsync"
    - path: "src/Services/PermissionService.cs"
      provides: "Permission management service"
      min_lines: 100
    - path: "src/UI/PermissionDialog.xaml"
      provides: "Permission request dialog"
      contains: "RequestPermission, InstructionText"
    - path: "src/UI/PermissionDialog.xaml.cs"
      provides: "Permission dialog implementation"
      contains: "RequestPermissionButtonClick"
  key_links:
    - from: "src/Services/AudioDeviceService.cs"
      to: "src/Services/PermissionService.cs"
      via: "dependency injection"
      pattern: "IPermissionService"
    - from: "src/Services/AudioDeviceService.cs"
      to: "Windows Privacy Settings"
      via: "Windows API"
      pattern: "RequestAccessAsync"
    - from: "src/UI/PermissionDialog.xaml"
      to: "src/Services/PermissionService.cs"
      via: "data binding"
      pattern: "DataContext.*PermissionService"
---

<objective>
Complete audio device selection and permission handling to fully satisfy SYS-03 requirement with robust device management.

Purpose: Ensure users can easily select audio devices and handle microphone permissions with professional user experience.
Output: Reliable audio device switching with comprehensive permission handling and user guidance.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-missing-implementation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Enhance AudioDeviceService with Permission Handling</name>
  <files>src/Services/AudioDeviceService.cs</files>
  <action>
Enhance existing AudioDeviceService:
- Add RequestMicrophonePermissionAsync method using Windows privacy APIs
- Add SwitchDeviceAsync method with proper device validation and error handling
- Implement device change monitoring with WM_DEVICECHANGE integration
- Add device compatibility testing and quality assessment methods
- Implement graceful fallback when preferred device unavailable
- Add device-specific configuration and calibration support
- Include detailed error reporting for permission issues
- Ensure async/await patterns for all device operations
- Add device testing methods to verify audio capture quality
  </action>
  <verify>
dotnet build --no-restore succeeds
</verify>
  <done>AudioDeviceService enhanced with comprehensive device management</done>
</task>

<task type="auto">
  <name>Create PermissionService</name>
  <files>src/Services/PermissionService.cs</files>
  <action>
Create PermissionService with:
- IPermissionService interface for testability
- CheckMicrophonePermissionAsync method returning detailed status
- RequestMicrophonePermissionAsync with Windows integration
- GetPermissionStatusAsync with human-readable status messages
- OpenWindowsPrivacySettingsAsync to guide users to settings
- MonitorPermissionChangesAsync for real-time permission updates
- Permission request history tracking for troubleshooting
- Integration with Windows 10/11 privacy settings APIs
- Error handling for various permission states and scenarios
  </action>
  <verify>
dotnet build --no-restore succeeds
</verify>
  <done>PermissionService created with comprehensive permission management</done>
</task>

<task type="auto">
  <name>Create Permission Dialog UI</name>
  <files>src/UI/PermissionDialog.xaml, src/UI/PermissionDialog.xaml.cs</files>
  <action>
Create PermissionDialog for user-friendly permission requests:
- Modern WPF dialog with clear instructions and visuals
- Step-by-step guidance for enabling microphone access
- "Request Permission" button that triggers Windows permission flow
- "Open Settings" button to launch Windows privacy settings
- Visual status indicators (red/yellow/green) for permission state
- Retry mechanism for failed permission requests
- Help links to documentation and troubleshooting
- Responsive design that works on different screen sizes
- Integration with application theme and styling
- Auto-dismiss when permission granted
  </action>
  <verify>
dotnet build --no-restore succeeds
</verify>
  <done>PermissionDialog created with user-friendly permission handling</done>
</task>

</tasks>

<verification>
- AudioDeviceService successfully switches between different microphones
- PermissionService correctly detects microphone permission status
- Permission dialog provides clear guidance for enabling microphone access
- Device switching maintains audio quality and configuration
- Permission changes are detected and handled gracefully
- Users receive helpful error messages and guidance for permission issues
</verification>

<success_criteria>
- SYS-03 requirement fully implemented with professional audio device management
- Users can easily select and switch between audio devices
- Microphone permissions are handled gracefully with clear user guidance
- Device switching works reliably without audio interruption
- Permission handling integrates seamlessly with application workflow
- Error scenarios provide helpful resolution paths
</success_criteria>

<output>
After completion, create `.planning/phases/04-missing-implementation/04-03-SUMMARY.md`
</output>